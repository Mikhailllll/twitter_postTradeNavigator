# Twitter Post Trade Navigator

## Назначение проекта
Twitter Post Trade Navigator автоматизирует публикацию трейдинговых апдейтов в Twitter на основе сообщений из Telegram и аналитики DeepSeek. Пайплайн отслеживает торговые сигналы, формирует структурированные твит-нитки с блоком Binance, хранит историю публикаций и поддерживает режимы тестирования без фактической отправки сообщений.

## Архитектура пайплайна
1. **Источники данных**: бот Telegram получает уведомления о сделках и аналитические заметки, а клиент DeepSeek дополняет сигнал свежими инсайтами.
2. **Обработка событий**: главный скрипт `src/main.py` извлекает новое событие, проверяет состояние, нормализует поля (тикер, направление сделки, цены входа/выхода) и обогащает данные информацией от DeepSeek.
3. **Генерация сообщений**: модуль форматирования собирает каркас твит-нитки, добавляет блок Binance и подготавливает текст для Telegram- и Twitter-клиентов.
4. **Публикация**: Twitter-клиент отправляет твиты, Telegram-клиент подтверждает публикацию в исходный чат, при необходимости выполняется dry-run.
5. **Хранение состояния**: обновлённые метаданные сериализуются в `state.json`, что позволяет избежать дубликатов и отслеживать историю потоков.

Диаграмма ответственности:
- **Transport**: `telegram_client.py`, `deepseek_client.py`, `twitter_client.py`.
- **Services**: логика агрегации сигналов и генерации текстов.
- **Domain**: модель сделки и бизнес-правила формирования нитки.
- **Storage**: чтение/запись `state.json`, снапшоты Binance и история публикаций.

## Ключевые компоненты
- **`src/main.py`** — точка входа пайплайна. Организует опрос Telegram-бота, вызывает обработчики DeepSeek и Twitter, применяет режим `DRY_RUN`, управляет обновлением `state.json`.
- **Клиент Telegram** — получает входящие сигналы, отправляет служебные уведомления об успешной публикации и ошибках. Поддерживает фильтрацию по `ALLOWED_CHAT_IDS`.
- **Клиент DeepSeek** — выполняет запросы к API для дополнения сигнала аналитикой (например, ключевые уровни и риски). Использует экспоненциальный бэкофф и таймауты.
- **Клиент Twitter** — создаёт или продолжает твит-нитку, добавляет Binance-блок и завершает поток. Хендлит ограничения API, ретраи и идемпотентность.
- **Обработка текстов** — нормализует числа, приводит формат цен к двум десятичным, расставляет эмодзи/хэштеги, делит сообщения по 280 символов и распределяет смысловые части по твитам.
- **Хранение состояния** — модуль работы с `state.json`, обеспечивающий атомарную запись и резервное копирование, а также загрузку предыдущих публикаций.

## Быстрый старт
### 1. Подготовка окружения
- Установите Python 3.11+ и Poetry или virtualenv.
- (Опционально) Установите Node.js LTS, если планируется использовать дополнительные скрипты разработки.
- Склонируйте репозиторий и перейдите в директорию проекта:
  ```bash
  git clone git@github.com:<org>/twitter_postTradeNavigator.git
  cd twitter_postTradeNavigator
  ```

### 2. Установка зависимостей
- Создайте и активируйте виртуальное окружение:
  ```bash
  python -m venv .venv
  source .venv/bin/activate
  ```
- Установите Python-зависимости:
  ```bash
  pip install -r requirements.txt
  ```
- Для инструментов качества кода установите dev-зависимости (опционально):
  ```bash
  pip install -r requirements-dev.txt
  ```

### 3. Переменные окружения и секреты GitHub
| Название | Где задаётся | Обязательность | Назначение |
| --- | --- | --- | --- |
| `TELEGRAM_BOT_TOKEN` | `.env` / GitHub Secret | обязательно | Токен Telegram-бота для получения сигналов и отправки уведомлений |
| `TELEGRAM_CHAT_ID` | `.env` / GitHub Secret | обязательно | Целевой чат для подтверждений публикаций |
| `ALLOWED_CHAT_IDS` | `.env` | опционально | Список разрешённых источников сигналов, через запятую |
| `DEEPSEEK_API_KEY` | `.env` / GitHub Secret | обязательно | Ключ доступа к API DeepSeek |
| `DEEPSEEK_ENDPOINT` | `.env` | опционально | Альтернативный URL эндпоинта DeepSeek |
| `TWITTER_API_KEY` | `.env` / GitHub Secret | обязательно | Ключ приложения Twitter |
| `TWITTER_API_SECRET` | `.env` / GitHub Secret | обязательно | Секрет приложения Twitter |
| `TWITTER_ACCESS_TOKEN` | `.env` / GitHub Secret | обязательно | Токен доступа пользователя |
| `TWITTER_ACCESS_SECRET` | `.env` / GitHub Secret | обязательно | Секрет токена доступа |
| `BINANCE_API_KEY` | `.env` / GitHub Secret | опционально | Получение данных по позициям из Binance |
| `BINANCE_API_SECRET` | `.env` / GitHub Secret | опционально | Секрет Binance для подписи запросов |
| `DRY_RUN` | `.env` / GitHub Secret | опционально | Включение режима тестового запуска (значение `true`) |
| `LOG_LEVEL` | `.env` | опционально | Уровень логирования (`info`, `debug`, `warning`) |

Секреты GitHub Actions должны быть заданы в настройках репозитория (`Settings` → `Secrets and variables` → `Actions`). Для локального запуска создайте файл `.env` на основе `.env.example`.

## Режим DRY_RUN
Флаг `DRY_RUN=true` переводит пайплайн в режим симуляции:
- Telegram- и Twitter-клиенты работают в «пробном» режиме: сообщения логируются, но не отправляются.
- В `state.json` записывается отметка о тестовом прогоне, чтобы избежать ложных дублей при следующем реальном запуске.
- Binance-блок формируется, но помечается тегом `[DRY RUN]`.
- Логи содержат пометку `dry_run=true` для облегчения фильтрации.

## Структура `state.json`
```json
{
  "last_event_id": "telegram-message-id",
  "last_thread_id": "twitter-thread-id",
  "binance": {
    "positions": [
      {
        "symbol": "BTCUSDT",
        "side": "long",
        "entry_price": 42250.0,
        "size": 0.5,
        "updated_at": "2024-03-02T18:42:11Z"
      }
    ],
    "snapshot_at": "2024-03-02T18:42:15Z"
  },
  "history": [
    {
      "signal_id": "uuid",
      "tweet_id": "176123456789",
      "posted_at": "2024-03-02T18:42:19Z",
      "status": "posted",
      "dry_run": false
    }
  ]
}
```
- `last_event_id` предотвращает повторную обработку Telegram-сообщений.
- `last_thread_id` позволяет продолжить активную нитку при следующем запуске.
- Блок `binance` хранит актуальный снимок позиций и используется при генерации Binance-блока.
- Массив `history` обеспечивает аудит публикаций и помогает в разборе инцидентов.

## Правила формирования твит-нитки
1. Первый твит — сводка сделки: тикер, направление, цена входа/выхода, целевой профит/стоп.
2. Второй твит — аналитика от DeepSeek: ключевые уровни, контекст рынка, риски.
3. Далее — дополнительные детали (управление позицией, обновления ордеров) и метаданные (таймфрейм, источники).
4. Каждый твит ≤ 280 символов, предпочтительно заканчивать полными предложениями.
5. Хэштеги и эмодзи — не более трёх на твит, чтобы не снижать охват.
6. Ссылки на дополнительные материалы добавляются в последний твит.
7. Binance-блок вставляется перед финальным твитом с выводами.

## Правила формирования Binance-блока
- Формат: `Binance: BTCUSDT long 0.5 @ 42 250 → стоп 40 800 / тейк 45 000`.
- Значения округляются до двух знаков, разделитель тысяч — пробел.
- При множественных позициях блок превращается в маркированный список внутри одного твита.
- В режиме `DRY_RUN` блок отмечается как `[DRY RUN] Binance: ...`.
- Если данные недоступны, выводится заглушка `Binance: данные недоступны`, но нитка продолжается.

## Локальное тестирование
- Запуск модульных тестов:
  ```bash
  pytest
  ```
- Проверка стиля кода:
  ```bash
  ruff check src
  black --check src
  ```
- Опционально: проверить формат Markdown-документации:
  ```bash
  markdownlint README.md
  ```

## Развёртывание GitHub Actions
1. Создайте файл `.github/workflows/pipeline.yml` (или используйте существующий) с шагами: `checkout`, `setup-python`, установка зависимостей, запуск `ruff`, `black --check`, `pytest`, затем деплой (например, запуск скрипта публикации).
2. Убедитесь, что все секреты из таблицы заведены в GitHub Secrets.
3. Настройте расписание (`on: schedule`) или запуск по пушу в основную ветку.
4. Добавьте уведомление о неуспешных прогонов в Telegram через отдельный шаг (опционально).

## Чек-лист контрибьютора
- [ ] Добавлены или обновлены тесты
- [ ] Пройдены линтеры и форматтеры (`ruff`, `black`, `markdownlint`)
- [ ] Обновлена документация (`README.md`, `docs/`)
- [ ] Нет лишних форматных изменений
- [ ] Логи и обработка ошибок покрывают критические пути
- [ ] Описано влияние на сеть и производительность

